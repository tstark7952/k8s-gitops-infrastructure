---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: unifi-controller
  namespace: unifi
  labels:
    app: unifi-controller
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: unifi-controller
  template:
    metadata:
      labels:
        app: unifi-controller
    spec:
      initContainers:
      - name: import-cert
        image: lscr.io/linuxserver/unifi-network-application:10.0.162
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Installing certificate tools..."
          apt-get update && apt-get install -y openssl

          echo "Converting certificate to PKCS12 format..."
          openssl pkcs12 -export \
            -in /tls/tls.crt \
            -inkey /tls/tls.key \
            -out /tmp/unifi.p12 \
            -name unifi \
            -password pass:aircontrolenterprise

          echo "Waiting for keystore directory..."
          mkdir -p /config/data

          if [ -f /config/data/keystore ]; then
            echo "Backing up existing keystore..."
            cp /config/data/keystore /config/data/keystore.backup
          fi

          echo "Importing certificate into keystore..."
          keytool -importkeystore \
            -deststorepass aircontrolenterprise \
            -destkeypass aircontrolenterprise \
            -destkeystore /config/data/keystore \
            -srckeystore /tmp/unifi.p12 \
            -srcstoretype PKCS12 \
            -srcstorepass aircontrolenterprise \
            -alias unifi \
            -noprompt

          echo "Certificate import complete"
        volumeMounts:
        - name: config
          mountPath: /config
        - name: tls
          mountPath: /tls
          readOnly: true
      containers:
      - name: unifi
        image: lscr.io/linuxserver/unifi-network-application:10.0.162
        ports:
        - name: web-ui
          containerPort: 8443
          protocol: TCP
        - name: device-comm
          containerPort: 8080
          protocol: TCP
        - name: stun
          containerPort: 3478
          protocol: UDP
        - name: discovery
          containerPort: 10001
          protocol: UDP
        - name: guest-https
          containerPort: 8843
          protocol: TCP
        - name: guest-http
          containerPort: 8880
          protocol: TCP
        - name: speedtest
          containerPort: 6789
          protocol: TCP
        - name: syslog
          containerPort: 5514
          protocol: UDP
        env:
        - name: PUID
          value: "999"
        - name: PGID
          value: "999"
        - name: TZ
          value: "America/New_York"
        - name: MONGO_USER
          value: "unifi"
        - name: MONGO_PASS
          valueFrom:
            secretKeyRef:
              name: unifi-mongodb
              key: password
        - name: MONGO_HOST
          value: "unifi-db"
        - name: MONGO_PORT
          value: "27017"
        - name: MONGO_DBNAME
          value: "unifi"
        volumeMounts:
        - name: config
          mountPath: /config
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: unifi-data
      - name: tls
        secret:
          secretName: unifi-controller-tls
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: unifi-db
  namespace: unifi
  labels:
    app: unifi-db
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: unifi-db
  template:
    metadata:
      labels:
        app: unifi-db
    spec:
      containers:
      - name: mongodb
        image: mongo:4.4
        ports:
        - name: mongodb
          containerPort: 27017
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "unifi"
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: unifi-mongodb
              key: password
        - name: MONGO_INITDB_DATABASE
          value: "unifi"
        volumeMounts:
        - name: data
          mountPath: /data/db
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: unifi-db
