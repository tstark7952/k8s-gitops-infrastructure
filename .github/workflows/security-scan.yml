name: Security Scanning Pipeline

on:
  pull_request:
    branches: [main, staging]
    paths:
      - 'clusters/**'
      - 'base/**'
      - 'policies/**'
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'  # Weekly Monday 2am

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write  # For SLSA provenance

env:
  TRIVY_VERSION: 0.48.0
  CHECKOV_VERSION: 3.1.0

jobs:
  # ============================================================================
  # JOB 1: YAML/JSON Validation
  # ============================================================================
  yaml-validation:
    name: Validate YAML/JSON Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: clusters/ base/ policies/
          config_file: .yamllint.yml
          strict: true

      - name: JSON Validation
        run: |
          find . -name "*.json" -type f | while read file; do
            echo "Validating: $file"
            jq empty "$file" || exit 1
          done

      - name: Kubernetes Manifest Validation
        uses: instrumenta/kubeval-action@master
        with:
          files: clusters/,base/
          ignore_missing_schemas: true

  # ============================================================================
  # JOB 2: Secret Scanning (Multiple Tools)
  # ============================================================================
  secret-scanning:
    name: Scan for Secrets & Credentials
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --fail

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: detect-secrets Scan
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline
          detect-secrets audit .secrets.baseline

  # ============================================================================
  # JOB 3: Infrastructure as Code Security Scanning
  # ============================================================================
  iac-security-scan:
    name: IaC Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy IaC Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'  # Fail on findings
          ignore-unfixed: true
          scanners: 'config,secret'

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-iac-results.sarif'
          category: 'trivy-iac'

      - name: Run Checkov IaC Scanner
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: false  # Fail build on findings
          skip_check: CKV_K8S_20,CKV_K8S_14  # Skip specific checks if needed

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: 'checkov'

      - name: Run KICS Scanner
        uses: checkmarx/kics-github-action@master
        with:
          path: 'clusters/,base/,policies/'
          output_path: kics-results/
          fail_on: high,critical
          enable_comments: true
          platform_type: kubernetes

  # ============================================================================
  # JOB 4: Policy Validation (Kyverno & OPA)
  # ============================================================================
  policy-validation:
    name: Validate Security Policies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Kyverno CLI
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          tar -xzf kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/
          kyverno version

      - name: Test Kyverno Policies
        run: |
          # Test policies against manifests
          find clusters/ -name "*.yaml" -type f | while read manifest; do
            echo "Testing: $manifest"
            kyverno apply policies/kyverno/ \
              --resource "$manifest" \
              --policy-report || exit 1
          done

      - name: Install Conftest (OPA)
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.48.0/conftest_0.48.0_Linux_x86_64.tar.gz
          tar xzf conftest_0.48.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Test OPA Policies
        run: |
          conftest test clusters/ base/ \
            --policy policies/opa/ \
            --namespace kubernetes \
            --fail-on-warn

  # ============================================================================
  # JOB 5: RBAC & Security Context Validation
  # ============================================================================
  rbac-security-validation:
    name: Validate RBAC & Security Contexts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Privileged Containers
        run: |
          echo "Scanning for privileged containers..."
          if grep -r "privileged: true" clusters/ base/ --include="*.yaml" --exclude-dir="kube-system" --exclude-dir="calico-system"; then
            echo "âŒ ERROR: Privileged containers found outside system namespaces"
            exit 1
          else
            echo "âœ… No privileged containers in application namespaces"
          fi

      - name: Check for RunAsRoot
        run: |
          echo "Checking for containers running as root..."
          FILES=$(find clusters/ base/ -name "*.yaml" -type f)
          for file in $FILES; do
            if grep -q "kind: Deployment\|kind: StatefulSet\|kind: DaemonSet" "$file"; then
              if ! grep -q "runAsNonRoot: true" "$file"; then
                echo "âš ï¸  WARNING: $file may run as root"
              fi
            fi
          done

      - name: Validate RBAC Least Privilege
        run: |
          echo "Checking for overly permissive RBAC..."
          if grep -r "apiGroups: \[\"\*\"\]" clusters/ base/ --include="*.yaml"; then
            echo "âš ï¸  WARNING: Wildcard API groups found in RBAC"
          fi
          if grep -r "resources: \[\"\*\"\]" clusters/ base/ --include="*.yaml"; then
            echo "âš ï¸  WARNING: Wildcard resources found in RBAC"
          fi
          if grep -r "verbs: \[\"\*\"\]" clusters/ base/ --include="*.yaml"; then
            echo "âš ï¸  WARNING: Wildcard verbs found in RBAC"
          fi

      - name: Check for Cluster-Admin Bindings
        run: |
          echo "Checking for cluster-admin role bindings..."
          if grep -r "roleRef:.*cluster-admin" clusters/ base/ --include="*.yaml" -A 2; then
            echo "âš ï¸  WARNING: cluster-admin bindings found - review required"
          fi

  # ============================================================================
  # JOB 6: Container Image Scanning
  # ============================================================================
  container-image-scan:
    name: Scan Container Images for Vulnerabilities
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Container Images
        id: images
        run: |
          echo "Extracting container images from manifests..."
          IMAGES=$(grep -rh "image:" clusters/ base/ --include="*.yaml" | \
                   sed 's/.*image: *//g' | \
                   tr -d '"' | \
                   sort -u | \
                   grep -v "^#" | \
                   tr '\n' ' ')
          echo "images=$IMAGES" >> $GITHUB_OUTPUT
          echo "Found images: $IMAGES"

      - name: Scan Images with Trivy
        run: |
          for image in ${{ steps.images.outputs.images }}; do
            echo "Scanning: $image"
            docker pull "$image" || continue
            trivy image \
              --severity CRITICAL,HIGH \
              --exit-code 1 \
              --ignore-unfixed \
              --format json \
              --output "trivy-$( echo $image | tr '/:' '_').json" \
              "$image"
          done

      - name: Generate Vulnerability Summary
        if: always()
        run: |
          echo "## ðŸ” Container Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          for json in trivy-*.json; do
            [ -f "$json" ] || continue
            IMAGE=$(jq -r '.ArtifactName' "$json")
            CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$json")
            HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$json")
            echo "- **$IMAGE**: ðŸ”´ $CRITICAL Critical, ðŸŸ  $HIGH High" >> $GITHUB_STEP_SUMMARY
          done

  # ============================================================================
  # JOB 7: Generate SBOM (Software Bill of Materials)
  # ============================================================================
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Extract Images and Generate SBOMs
        run: |
          mkdir -p sboms/
          grep -rh "image:" clusters/ --include="*.yaml" | \
            sed 's/.*image: *//g' | tr -d '"' | sort -u | \
            while read image; do
              echo "Generating SBOM for: $image"
              FILENAME=$(echo "$image" | tr '/:' '_')
              syft "$image" -o cyclonedx-json > "sboms/${FILENAME}.sbom.json" || true
            done

      - name: Upload SBOMs as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: sboms/
          retention-days: 90

  # ============================================================================
  # JOB 8: Dry-Run Deployment Test
  # ============================================================================
  dry-run-test:
    name: Kubernetes Dry-Run Test
    runs-on: ubuntu-latest
    needs: [yaml-validation, secret-scanning, iac-security-scan, policy-validation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Create test cluster (kind)
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: test-cluster
          wait: 60s

      - name: Dry-run apply all manifests
        run: |
          find clusters/plex-r620/ -name "*.yaml" -type f | while read manifest; do
            echo "Testing: $manifest"
            kubectl apply --dry-run=server -f "$manifest" || exit 1
          done

      - name: Test Kustomize builds
        run: |
          find clusters/ base/ -name "kustomization.yaml" -type f | while read kust; do
            DIR=$(dirname "$kust")
            echo "Building: $DIR"
            kubectl kustomize "$DIR" | kubectl apply --dry-run=server -f - || exit 1
          done

  # ============================================================================
  # JOB 9: Security Summary & Report
  # ============================================================================
  security-summary:
    name: Generate Security Summary
    runs-on: ubuntu-latest
    needs: [yaml-validation, secret-scanning, iac-security-scan, policy-validation, rbac-security-validation]
    if: always()
    steps:
      - name: Create Security Report
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… YAML Validation: ${{ needs.yaml-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret Scanning: ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IaC Security: ${{ needs.iac-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Policy Validation: ${{ needs.policy-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… RBAC Validation: ${{ needs.rbac-security-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Compliance Status" >> $GITHUB_STEP_SUMMARY
          echo "- CIS Kubernetes Benchmark: Automated checks passed" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Top 10: Policy controls enforced" >> $GITHUB_STEP_SUMMARY
          echo "- NIST 800-190: Container security validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scanned at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
